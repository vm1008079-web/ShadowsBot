import { promises as fs } from 'fs';

let handler = async (m, { conn, text, usedPrefix, command, isAdmin, isOwner }) => {
    try {
        // Verificar si hay texto para enviar
        if (!text) {
            return await conn.sendMessage(m.chat, {
                text: `☠️ *𝐔𝐒𝐎 𝐃𝐄𝐋 𝐏𝐎𝐃𝐄𝐑 𝐃𝐈𝐕𝐈𝐍𝐎*\n\n${usedPrefix}${command} <mensaje>\n\n*𝐄𝐉𝐄𝐌𝐏𝐋𝐎:*\n${usedPrefix}${command} 𝐋𝐀 𝐌𝐄𝐑𝐄𝐂𝐈𝐃𝐀 𝐃𝐄 𝐋𝐎𝐒 𝐌𝐎𝐑𝐓𝐀𝐋𝐄𝐒 𝐇𝐀 𝐋𝐋𝐄𝐆𝐀𝐃𝐎 𝐀 𝐒𝐔 𝐅𝐈𝐍... 🌑`,
                contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true
                }
            }, { quoted: m });
        }

        // Frases malévolas de Goku Black
        const gokuBlackPhrases = [
            "𝐋𝐀 𝐏𝐑𝐎𝐅𝐄𝐂𝐈𝐀 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒 𝐒𝐄 𝐂𝐔𝐌𝐏𝐋𝐄...",
            "𝐄𝐋 𝐕𝐀𝐂Í𝐎 𝐂𝐎𝐍𝐒𝐔𝐌𝐄 𝐓𝐔 𝐄𝐗𝐈𝐒𝐓𝐄𝐍𝐂𝐈𝐀...",
            "𝐋𝐀 𝐎𝐒𝐂𝐔𝐑𝐈𝐃𝐀𝐃 𝐓𝐄 𝐀𝐋𝐂𝐀𝐍𝐙𝐀𝐑𝐀...",
            "𝐒𝐈𝐄𝐍𝐓𝐄 𝐄𝐋 𝐏𝐎𝐃𝐄𝐑 𝐃𝐄𝐋 𝐕𝐄𝐑𝐃𝐀𝐃𝐄𝐑𝐎 𝐃𝐈𝐎𝐒...",
            "𝐓𝐔 𝐌𝐔𝐍𝐃𝐎 𝐒𝐄 𝐃𝐄𝐒𝐕𝐀𝐍𝐄𝐂𝐄𝐑𝐀 𝐀𝐍𝐓𝐄 𝐌Í...",
            "𝐋𝐀 𝐉𝐔𝐒𝐓𝐈𝐂𝐈𝐀 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒 𝐄𝐒 𝐈𝐌𝐏𝐋𝐀𝐂𝐀𝐁𝐋𝐄...",
            "𝐄𝐋 𝐅𝐈𝐍 𝐃𝐄 𝐓𝐔 𝐑𝐀𝐙𝐀 𝐈𝐍𝐅𝐄𝐑𝐈𝐎𝐑 𝐒𝐄 𝐀𝐂𝐄𝐑𝐂𝐀..."
        ];

        // Obtener todos los chats del bot
        const chats = await conn.chats.all();
        
        // Filtrar solo grupos donde el usuario es admin
        const userGroups = chats.filter(chat => 
            chat.type === 'group' && 
            chat.participants && 
            chat.participants.some(p => 
                p.id === m.sender && 
                (p.admin === 'admin' || p.admin === 'superadmin')
            )
        );

        if (userGroups.length === 0) {
            return await conn.sendMessage(m.chat, {
                text: '❌ *𝐍𝐎 𝐄𝐑𝐄𝐒 𝐃𝐈𝐎𝐒 𝐄𝐍 𝐍𝐈𝐍𝐆𝐔𝐍 𝐆𝐑𝐔𝐏𝐎*\n\n𝐓𝐮 𝐩𝐨𝐝𝐞𝐫 𝐞𝐬 𝐢𝐧𝐬𝐮𝐟𝐢𝐜𝐢𝐞𝐧𝐭𝐞 𝐩𝐚𝐫𝐚 𝐠𝐨𝐛𝐞𝐫𝐧𝐚𝐫 𝐞𝐬𝐭𝐞 𝐮𝐧𝐢𝐯𝐞𝐫𝐬𝐨... 💀',
                contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true
                }
            }, { quoted: m });
        }

        // Contador de mensajes enviados
        let successCount = 0;
        let failCount = 0;
        
        // Mensaje de inicio con estilo Goku Black
        const randomPhrase = gokuBlackPhrases[Math.floor(Math.random() * gokuBlackPhrases.length)];
        await conn.sendMessage(m.chat, {
            text: `⚡ *𝐄𝐋 𝐏𝐎𝐃𝐄𝐑 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒 𝐒𝐄 𝐌𝐀𝐍𝐈𝐅𝐈𝐄𝐒𝐓𝐀*...\n\n${randomPhrase}\n\n📤 *𝐄𝐧𝐯𝐢𝐚𝐧𝐝𝐨 𝐚 ${userGroups.length} 𝐮𝐧𝐢𝐯𝐞𝐫𝐬𝐨𝐬...* ⏳`,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });

        // Enviar mensaje a cada grupo con estilo malévolo
        for (const group of userGroups) {
            try {
                const groupPhrase = gokuBlackPhrases[Math.floor(Math.random() * gokuBlackPhrases.length)];
                
                await conn.sendMessage(group.id, {
                    text: `🐉 *𝐏𝐑𝐎𝐍𝐔𝐍𝐂𝐈𝐀𝐌𝐈𝐄𝐍𝐓𝐎 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒 𝐍𝐄𝐆𝐑𝐎*\n\n╔══════════════════╗\n   𝐁𝐋𝐀𝐂𝐊-𝐁𝐎𝐓 𝐌𝐃\n╚══════════════════╝\n\n${text}\n\n╔══════════════════╗\n${groupPhrase}\n╚══════════════════╝\n\n_𝐏𝐨𝐝𝐞𝐫 𝐝𝐞: @${m.sender.split('@')[0]}_`,
                    contextInfo: {
                        mentionedJid: [m.sender],
                        forwardingScore: 999,
                        isForwarded: true
                    }
                });
                successCount++;
                
                // Pequeña pausa dramática
                await new Promise(resolve => setTimeout(resolve, 1500));
                
            } catch (error) {
                console.error(`Error enviando a ${group.id}:`, error);
                failCount++;
            }
        }

        // Mensaje de resumen con estilo irónico
        const summaryMessage = `╔══════════════════╗\n   𝐏𝐑𝐎𝐅𝐄𝐂𝐈𝐀 𝐂𝐔𝐌𝐏𝐋𝐈𝐃𝐀\n╚══════════════════╝

📊 *𝐑𝐄𝐒𝐔𝐋𝐓𝐀𝐃𝐎𝐒 𝐃𝐄𝐋 𝐏𝐎𝐃𝐄𝐑 𝐃𝐈𝐕𝐈𝐍𝐎:*
• ✅ 𝐔𝐧𝐢𝐯𝐞𝐫𝐬𝐨𝐬 𝐝𝐨𝐦𝐢𝐧𝐚𝐝𝐨𝐬: ${successCount}
• ❌ 𝐔𝐧𝐢𝐯𝐞𝐫𝐬𝐨𝐬 𝐫𝐞𝐬𝐢𝐬𝐭𝐞𝐧𝐭𝐞𝐬: ${failCount}
• 📋 𝐓𝐨𝐭𝐚𝐥 𝐝𝐞 𝐫𝐞𝐚𝐥𝐢𝐝𝐚𝐝𝐞𝐬: ${userGroups.length}

🐉 *𝐌𝐄𝐍𝐒𝐀𝐉𝐄 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒:*
${text}

╔══════════════════╗\n  𝐄𝐋 𝐃𝐈𝐎𝐒 𝐍𝐎 𝐂𝐎𝐍𝐎𝐂𝐄 𝐄𝐋 𝐅𝐑𝐀𝐂𝐀𝐒𝐎\n╚══════════════════╝`;

        await conn.sendMessage(m.chat, {
            text: summaryMessage,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });

        // React con emoji de dragón
        await m.react('🐉');

    } catch (error) {
        console.error('Error en el poder divino:', error);
        
        // Mensaje de error con estilo Goku Black
        await conn.sendMessage(m.chat, {
            text: `💀 *𝐄𝐋 𝐏𝐎𝐃𝐄𝐑 𝐃𝐄𝐋 𝐃𝐈𝐎𝐒 𝐅𝐀𝐋𝐋𝐎́*\n\n𝐄𝐥 𝐯𝐚𝐜í𝐨 𝐧𝐨 𝐩𝐮𝐝𝐨 𝐚𝐛𝐬𝐨𝐫𝐛𝐞𝐫 𝐥𝐚𝐬 𝐦𝐞𝐧𝐬𝐚𝐣𝐞𝐫𝐢𝐚𝐬 𝐦𝐨𝐫𝐭𝐚𝐥𝐞𝐬...\n\n*𝐄𝐫𝐫𝐨𝐫:* ${error.message}`,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });
        
        await m.react('💀');
    }
}

// Help con estilo Goku Black
handler.help = ['informar <mensaje> :: 𝐄𝐥 𝐝𝐢𝐨𝐬 𝐞𝐧𝐯í𝐚 𝐬𝐮 𝐩𝐫𝐨𝐧𝐮𝐧𝐜𝐢𝐚𝐦𝐢𝐞𝐧𝐭𝐨 𝐚 𝐭𝐨𝐝𝐨𝐬 𝐥𝐨𝐬 𝐮𝐧𝐢𝐯𝐞𝐫𝐬𝐨𝐬'];
handler.tags = ['admin', 'dios'];
handler.command = ['informar', 'pronunciamiento', 'profecia', 'anunciardios', 'blackbroadcast'];
handler.admin = true;
handler.group = false;
handler.botAdmin = false;

export default handler;
