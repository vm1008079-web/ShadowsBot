import { promises as fs } from 'fs';

let handler = async (m, { conn, text, usedPrefix, command, isAdmin, isOwner }) => {
    try {
        // Verificar si hay texto para enviar
        if (!text) {
            return await conn.sendMessage(m.chat, {
                text: `â˜ ï¸ *ğ”ğ’ğ ğƒğ„ğ‹ ğğğƒğ„ğ‘ ğƒğˆğ•ğˆğğ*\n\n${usedPrefix}${command} <mensaje>\n\n*ğ„ğ‰ğ„ğŒğğ‹ğ:*\n${usedPrefix}${command} ğ‹ğ€ ğŒğ„ğ‘ğ„ğ‚ğˆğƒğ€ ğƒğ„ ğ‹ğğ’ ğŒğğ‘ğ“ğ€ğ‹ğ„ğ’ ğ‡ğ€ ğ‹ğ‹ğ„ğ†ğ€ğƒğ ğ€ ğ’ğ” ğ…ğˆğ... ğŸŒ‘`,
                contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true
                }
            }, { quoted: m });
        }

        // Frases malÃ©volas de Goku Black
        const gokuBlackPhrases = [
            "ğ‹ğ€ ğğ‘ğğ…ğ„ğ‚ğˆğ€ ğƒğ„ğ‹ ğƒğˆğğ’ ğ’ğ„ ğ‚ğ”ğŒğğ‹ğ„...",
            "ğ„ğ‹ ğ•ğ€ğ‚Ãğ ğ‚ğğğ’ğ”ğŒğ„ ğ“ğ” ğ„ğ—ğˆğ’ğ“ğ„ğğ‚ğˆğ€...",
            "ğ‹ğ€ ğğ’ğ‚ğ”ğ‘ğˆğƒğ€ğƒ ğ“ğ„ ğ€ğ‹ğ‚ğ€ğğ™ğ€ğ‘ğ€...",
            "ğ’ğˆğ„ğğ“ğ„ ğ„ğ‹ ğğğƒğ„ğ‘ ğƒğ„ğ‹ ğ•ğ„ğ‘ğƒğ€ğƒğ„ğ‘ğ ğƒğˆğğ’...",
            "ğ“ğ” ğŒğ”ğğƒğ ğ’ğ„ ğƒğ„ğ’ğ•ğ€ğğ„ğ‚ğ„ğ‘ğ€ ğ€ğğ“ğ„ ğŒÃ...",
            "ğ‹ğ€ ğ‰ğ”ğ’ğ“ğˆğ‚ğˆğ€ ğƒğ„ğ‹ ğƒğˆğğ’ ğ„ğ’ ğˆğŒğğ‹ğ€ğ‚ğ€ğğ‹ğ„...",
            "ğ„ğ‹ ğ…ğˆğ ğƒğ„ ğ“ğ” ğ‘ğ€ğ™ğ€ ğˆğğ…ğ„ğ‘ğˆğğ‘ ğ’ğ„ ğ€ğ‚ğ„ğ‘ğ‚ğ€..."
        ];

        // Obtener todos los chats del bot
        const chats = await conn.chats.all();
        
        // Filtrar solo grupos donde el usuario es admin
        const userGroups = chats.filter(chat => 
            chat.type === 'group' && 
            chat.participants && 
            chat.participants.some(p => 
                p.id === m.sender && 
                (p.admin === 'admin' || p.admin === 'superadmin')
            )
        );

        if (userGroups.length === 0) {
            return await conn.sendMessage(m.chat, {
                text: 'âŒ *ğğ ğ„ğ‘ğ„ğ’ ğƒğˆğğ’ ğ„ğ ğğˆğğ†ğ”ğ ğ†ğ‘ğ”ğğ*\n\nğ“ğ® ğ©ğ¨ğğğ« ğğ¬ ğ¢ğ§ğ¬ğ®ğŸğ¢ğœğ¢ğğ§ğ­ğ ğ©ğšğ«ğš ğ ğ¨ğ›ğğ«ğ§ğšğ« ğğ¬ğ­ğ ğ®ğ§ğ¢ğ¯ğğ«ğ¬ğ¨... ğŸ’€',
                contextInfo: {
                    mentionedJid: [m.sender],
                    forwardingScore: 999,
                    isForwarded: true
                }
            }, { quoted: m });
        }

        // Contador de mensajes enviados
        let successCount = 0;
        let failCount = 0;
        
        // Mensaje de inicio con estilo Goku Black
        const randomPhrase = gokuBlackPhrases[Math.floor(Math.random() * gokuBlackPhrases.length)];
        await conn.sendMessage(m.chat, {
            text: `âš¡ *ğ„ğ‹ ğğğƒğ„ğ‘ ğƒğ„ğ‹ ğƒğˆğğ’ ğ’ğ„ ğŒğ€ğğˆğ…ğˆğ„ğ’ğ“ğ€*...\n\n${randomPhrase}\n\nğŸ“¤ *ğ„ğ§ğ¯ğ¢ğšğ§ğğ¨ ğš ${userGroups.length} ğ®ğ§ğ¢ğ¯ğğ«ğ¬ğ¨ğ¬...* â³`,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });

        // Enviar mensaje a cada grupo con estilo malÃ©volo
        for (const group of userGroups) {
            try {
                const groupPhrase = gokuBlackPhrases[Math.floor(Math.random() * gokuBlackPhrases.length)];
                
                await conn.sendMessage(group.id, {
                    text: `ğŸ‰ *ğğ‘ğğğ”ğğ‚ğˆğ€ğŒğˆğ„ğğ“ğ ğƒğ„ğ‹ ğƒğˆğğ’ ğğ„ğ†ğ‘ğ*\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n   ğğ‹ğ€ğ‚ğŠ-ğğğ“ ğŒğƒ\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n${text}\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n${groupPhrase}\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n_ğğ¨ğğğ« ğğ: @${m.sender.split('@')[0]}_`,
                    contextInfo: {
                        mentionedJid: [m.sender],
                        forwardingScore: 999,
                        isForwarded: true
                    }
                });
                successCount++;
                
                // PequeÃ±a pausa dramÃ¡tica
                await new Promise(resolve => setTimeout(resolve, 1500));
                
            } catch (error) {
                console.error(`Error enviando a ${group.id}:`, error);
                failCount++;
            }
        }

        // Mensaje de resumen con estilo irÃ³nico
        const summaryMessage = `â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n   ğğ‘ğğ…ğ„ğ‚ğˆğ€ ğ‚ğ”ğŒğğ‹ğˆğƒğ€\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š *ğ‘ğ„ğ’ğ”ğ‹ğ“ğ€ğƒğğ’ ğƒğ„ğ‹ ğğğƒğ„ğ‘ ğƒğˆğ•ğˆğğ:*
â€¢ âœ… ğ”ğ§ğ¢ğ¯ğğ«ğ¬ğ¨ğ¬ ğğ¨ğ¦ğ¢ğ§ğšğğ¨ğ¬: ${successCount}
â€¢ âŒ ğ”ğ§ğ¢ğ¯ğğ«ğ¬ğ¨ğ¬ ğ«ğğ¬ğ¢ğ¬ğ­ğğ§ğ­ğğ¬: ${failCount}
â€¢ ğŸ“‹ ğ“ğ¨ğ­ğšğ¥ ğğ ğ«ğğšğ¥ğ¢ğğšğğğ¬: ${userGroups.length}

ğŸ‰ *ğŒğ„ğğ’ğ€ğ‰ğ„ ğƒğ„ğ‹ ğƒğˆğğ’:*
${text}

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n  ğ„ğ‹ ğƒğˆğğ’ ğğ ğ‚ğğğğ‚ğ„ ğ„ğ‹ ğ…ğ‘ğ€ğ‚ğ€ğ’ğ\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;

        await conn.sendMessage(m.chat, {
            text: summaryMessage,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });

        // React con emoji de dragÃ³n
        await m.react('ğŸ‰');

    } catch (error) {
        console.error('Error en el poder divino:', error);
        
        // Mensaje de error con estilo Goku Black
        await conn.sendMessage(m.chat, {
            text: `ğŸ’€ *ğ„ğ‹ ğğğƒğ„ğ‘ ğƒğ„ğ‹ ğƒğˆğğ’ ğ…ğ€ğ‹ğ‹ğÌ*\n\nğ„ğ¥ ğ¯ğšğœÃ­ğ¨ ğ§ğ¨ ğ©ğ®ğğ¨ ğšğ›ğ¬ğ¨ğ«ğ›ğğ« ğ¥ğšğ¬ ğ¦ğğ§ğ¬ğšğ£ğğ«ğ¢ğšğ¬ ğ¦ğ¨ğ«ğ­ğšğ¥ğğ¬...\n\n*ğ„ğ«ğ«ğ¨ğ«:* ${error.message}`,
            contextInfo: {
                mentionedJid: [m.sender],
                forwardingScore: 999,
                isForwarded: true
            }
        }, { quoted: m });
        
        await m.react('ğŸ’€');
    }
}

// Help con estilo Goku Black
handler.help = ['informar <mensaje> :: ğ„ğ¥ ğğ¢ğ¨ğ¬ ğğ§ğ¯Ã­ğš ğ¬ğ® ğ©ğ«ğ¨ğ§ğ®ğ§ğœğ¢ğšğ¦ğ¢ğğ§ğ­ğ¨ ğš ğ­ğ¨ğğ¨ğ¬ ğ¥ğ¨ğ¬ ğ®ğ§ğ¢ğ¯ğğ«ğ¬ğ¨ğ¬'];
handler.tags = ['admin', 'dios'];
handler.command = ['informar', 'pronunciamiento', 'profecia', 'anunciardios', 'blackbroadcast'];
handler.admin = true;
handler.group = false;
handler.botAdmin = false;

export default handler;
